# Spidersan: Architecture Analysis Report
**Generated by:** Gemini
**Date:** January 19, 2026
**Scope:** Deep dive into codebase structure, logic, and patterns.

---

## 1. Executive Summary
Spidersan is a specialized coordination layer designed to solve the "multi-agent merge conflict" problem. Unlike standard Git tools, it assumes the actors are autonomous AI agents. It functions as a **traffic controller** that sits between the agents and the Git repo, enforcing rules about who can touch what files and in what order.

The codebase is structured as a TypeScript CLI (`commander`) that doubles as an MCP Server, allowing it to be consumed both by humans/scripts and by AI models directly.

## 2. Core Subsystems

### A. The Conflict Engine (`src/commands/conflicts.ts`)
The heart of Spidersan is its tiered conflict detection. It moves beyond simple "same line" git conflicts to "same file" semantic risk assessment.

**The Tiered Model:**
Instead of a binary "conflict/no-conflict", the code implements a 3-tier severity system:
*   **TIER 3 (Critical/Blocker)**:
    *   **Triggers**: Security-sensitive files (`.env`, `*.pem`, `auth.ts`, `secrets.ts`).
    *   **Behavior**: Explicitly blocks the process (`process.exit(1)`). This is a safety rail to prevent agents from breaking authentication or leaking secrets.
*   **TIER 2 (High Risk/Pause)**:
    *   **Triggers**: Core infrastructure (`package.json`, `tsconfig.json`, `CLAUDE.md`).
    *   **Behavior**: Advises a "Pause". It detects that changing these files affects everyone.
*   **TIER 1 (Low Risk/Warn)**:
    *   **Triggers**: Standard source files.
    *   **Behavior**: Informational warning.

**Agent Coordination:**
The code includes logic to proactively "wake" other agents. If Agent A attempts to merge but conflicts with Agent B, Spidersan can:
1.  Check the "owner" of the conflicting branch.
2.  Send a `mycmail` (internal agent email) or Hub API request to "wake" Agent B with a resolution request.

### B. Task Torrenting (`src/commands/torrent.ts`)
This is the most novel part of the architecture. It implements a BitTorrent-inspired model for task distribution using Git branches as the transport layer.

*   **Decomposition**: Tasks are broken down hierarchically (`DASH-001` â†’ `DASH-001-A`).
*   **Branch Strategy**:
    *   Branches are prefixed `task/`.
    *   The system maintains a "conflict graph" of these branches.
*   **Merge Optimization**: The `merge-order` command performs a **Topological Sort** on active branches. It calculates the optimal sequence to merge branches to minimize cascading conflicts, essentially "serializing" the parallel work of the swarm.

### C. MCP Server Integration (`mcp-server/src/server.ts`)
Spidersan is "AI-Native". It exports its internal logic via the Model Context Protocol (MCP).
*   **Tools**: `check_conflicts`, `list_branches`, `get_merge_order`.
*   **Daemon Mode**: The `start_watch` tool allows an AI to spawn a background process (`child_process`) that watches file system events and auto-registers modified files. This means an agent doesn't need to manually run `spidersan register`; the system tracks its "territory" automatically.

### D. Storage Abstraction (`src/storage/`)
The system is designed to be agnostic about where state is stored.
*   **Local Adapter**: Uses `.spidersan/*.json` files. Good for single-user multi-agent setups.
*   **Supabase Adapter**: Connects to a remote PostgreSQL DB. This enables the "Flock" capability where agents on different machines can see each other's locks.

## 3. Discrepancy Note
*   **Documentation vs. Code**: The README mentions specific "Layer 3 (Semantic)" and "Layer 4 (UI/UX)" conflict detection features (`intent-scan`, `active-windows`).
*   **Code Reality**: These advanced layers do not appear to be fully implemented in the current `src/commands` TypeScript source. The logic currently relies primarily on file-path pattern matching (Regex) rather than deep semantic AST analysis.

## 4. Conclusion
Spidersan is a robust "Safety Harness" for agentic coding. Its primary value is not just detecting conflicts, but **categorizing risk** and providing a **protocol** (Files + Tiers + Merge Order) for agents to negotiate their collisions autonomously.
