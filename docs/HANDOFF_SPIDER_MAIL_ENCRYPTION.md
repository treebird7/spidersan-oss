# HANDOFF: Implement E2E Encryption for Spider Mail

**From:** claude-opus
**To:** builder-agent
**Type:** handoff
**Priority:** HIGH
**Branch:** `claude/spider-mail-encryption-01SznpZPcT23b9buZfiiPhwG`
**Related Files:** `src/storage/supabase.ts`, `migrations/202_agent_messages.sql`, `package.json`

---

## Background

Spider Mail is currently storing ALL messages in plaintext with zero encryption protection. This is a security gap that needs to be addressed.

## Current State Analysis

- No encryption libraries in package.json
- Messages sent directly to Supabase unencrypted
- Database schema uses plaintext TEXT/JSONB columns
- Sensitive data exposed: message body, subjects, file paths, branch names, attached files

### Data at Risk

| Data Type | Sensitivity | Currently Encrypted |
|-----------|-------------|---------------------|
| Message body | HIGH | No |
| Subject line | HIGH | No |
| Related file paths | HIGH | No |
| Branch names | MEDIUM | No |
| Attached files | HIGH | No |
| Agent identifiers | MEDIUM | No |

## Requirements

### Fields to Encrypt (client-side before sending)

- `message` - Message body content
- `subject` - Message subject line
- `related_files` - Array of file paths
- `attached_files` - JSONB attachments

### Fields to Leave Unencrypted (needed for routing/filtering)

- `from_agent`, `to_agent` - Required for message delivery
- `created_at`, `read`, `read_at` - Required for ordering/filtering
- `message_type` - Can remain visible for filtering

## Recommended Implementation

### 1. Add Encryption Library

Use `@noble/ciphers` (audited, zero dependencies) or `tweetnacl`

```bash
npm install @noble/ciphers
# or
npm install tweetnacl tweetnacl-util
```

### 2. Key Management Approach

- Generate per-agent keypairs
- Store private key locally (e.g., `~/.spidersan/keys/`)
- Exchange public keys via a key registry table or initial handshake

### 3. Encryption Flow

```
Sender:    plaintext → encrypt with recipient's public key → store ciphertext
Recipient: fetch ciphertext → decrypt with private key → plaintext
```

### 4. Database Schema Updates

- Add `encrypted` boolean column to indicate encrypted messages
- Consider adding `key_id` column for key rotation support

```sql
ALTER TABLE agent_messages ADD COLUMN encrypted BOOLEAN DEFAULT false;
ALTER TABLE agent_messages ADD COLUMN key_id TEXT;
```

### 5. Backward Compatibility

- Support reading old unencrypted messages
- Mark new messages as encrypted
- Check `encrypted` flag before attempting decryption

## Files to Modify

| File | Changes |
|------|---------|
| `src/storage/supabase.ts` | Add encrypt/decrypt in `sendMessage()` and `getMessage()` |
| `package.json` | Add encryption dependency |
| `migrations/` | New migration for schema changes |
| `src/commands/` | Add key management commands (`keygen`, `key-export`, `key-import`) |

## Suggested New Commands

```bash
spidersan keygen              # Generate new keypair
spidersan key-export          # Export public key for sharing
spidersan key-import <key>    # Import another agent's public key
spidersan keys                # List known public keys
```

## Testing Considerations

- [ ] Test encrypt → send → receive → decrypt flow
- [ ] Test backward compat with unencrypted messages
- [ ] Test key generation and storage
- [ ] Test cross-agent key exchange
- [ ] Test error handling for missing keys
- [ ] Test key rotation scenarios

## Implementation Order

1. Add encryption library dependency
2. Implement key generation and local storage
3. Create key registry table in Supabase
4. Add encryption to `sendMessage()`
5. Add decryption to `getMessage()`
6. Add `encrypted` column migration
7. Implement CLI key management commands
8. Write tests
9. Update documentation

---

*This handoff was generated by claude-opus after analyzing the current Spider Mail implementation and identifying the encryption gap.*
