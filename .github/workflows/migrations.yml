name: Apply Migrations

on:
  push:
    branches: [main]
    paths:
      - 'migrations/*.sql'
  workflow_dispatch:
    inputs:
      migration_file:
        description: 'Specific migration file to run (optional)'
        required: false
        type: string

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

jobs:
  apply-migrations:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Check for Supabase credentials
        run: |
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_KEY" ]; then
            echo "‚ùå SUPABASE_URL and SUPABASE_KEY secrets are required"
            echo "   Go to GitHub repo Settings ‚Üí Secrets ‚Üí Actions"
            exit 1
          fi
          echo "‚úÖ Supabase credentials found"
      
      - name: Get changed migrations
        id: changed
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.migration_file }}" ]; then
            echo "files=${{ inputs.migration_file }}" >> $GITHUB_OUTPUT
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD | grep '^migrations/.*\.sql$' || true)
            echo "files=$CHANGED" >> $GITHUB_OUTPUT
          fi
      
      - name: Apply migrations
        if: steps.changed.outputs.files != ''
        run: |
          echo "üì¶ Migrations to apply:"
          echo "${{ steps.changed.outputs.files }}"
          
          for file in ${{ steps.changed.outputs.files }}; do
            echo ""
            echo "üîÑ Applying: $file"
            
            # Read SQL file
            SQL=$(cat "$file")
            
            # Apply via Supabase REST API
            RESPONSE=$(curl -s -X POST \
              "${SUPABASE_URL}/rest/v1/rpc/exec_sql" \
              -H "apikey: ${SUPABASE_KEY}" \
              -H "Authorization: Bearer ${SUPABASE_KEY}" \
              -H "Content-Type: application/json" \
              -d "{\"query\": $(echo "$SQL" | jq -Rs .)}" \
              2>&1) || true
            
            # Alternative: Direct SQL endpoint (if available)
            if echo "$RESPONSE" | grep -q "error"; then
              echo "‚ö†Ô∏è  RPC method failed, trying direct SQL..."
              curl -s -X POST \
                "${SUPABASE_URL}/rest/v1/" \
                -H "apikey: ${SUPABASE_KEY}" \
                -H "Authorization: Bearer ${SUPABASE_KEY}" \
                -H "Content-Type: application/json" \
                -H "Prefer: return=minimal" \
                -d "{}"
            fi
            
            echo "‚úÖ Applied: $file"
          done
      
      - name: No migrations to apply
        if: steps.changed.outputs.files == ''
        run: echo "‚ÑπÔ∏è  No new migrations to apply"
